{% set hsep = '-' if suffix else '' %}

{% set version = "0.1.0" %}
{% set bld_stage = "beta" %}
{% set bld_str = "v"~version %}
{% set version_str = (bld_stage and version~"-"~bld_stage) or version %}

{% set repo = "https://github.com/nk53/stanalyzer" %}
{% set branch = "sta-unstable" %}

package:
  name: stanalyzer{{ hsep }}{{ suffix }}
  version: {{ version }}

source:
  # url: {{ repo }}/archive/refs/tags/{{ bld_str }}.tar.gz
  git_url: {{ repo }}.git
  git_rev: {{ branch }}

build:
  number: 1
  string: {{ target_platform|replace("-", "_") }}
  noarch: python
  skip: True  # [win]
{% if suffix %}
  script_env:
    - STA_SUFFIX={{ suffix }}
{% endif %}
  entry_points:
    - stanalyzer = stanalyzer.cli.stanalyzer:main
{% if suffix != 'client' %}
    - sta-server = stanalyzer.cli.stanalyzer:run_server
{% endif %}
{% if suffix == 'dev' %}
    - sta-finish-install = stanalyzer:finish_install
{% endif %}

about:
  home: {{ repo }}
  license: MIT
  license_file: LICENSE
  license_url: {{ repo }}/blob/{{ branch }}/LICENSE
  summary: Command-line and web interface for common simulation trajectory analysis
  description: |
    An extensible framework for analyzing molecular dynamics simulation trajectories. Several analysis programs are provided, and sophisticated users can add their own analysis types.
  dev_url: {{ repo }}
  doc_url: {{ repo }}/blob/{{ branch }}/README.md
  doc_source_url: {{ repo }}/blob/{{ branch }}/README.md

test:
  requires:
    - python {{ python_min }}
  imports:
    - stanalyzer
{% if suffix != 'dev' %}
    - stanalyzer.cli.stanalyzer
{% endif %}
  commands:
{% if suffix == 'dev' %}
#    - sta-finish-install -h
{% else %}
    - stanalyzer -h
    - stanalyzer system_size -h
{% endif %}

requirements:
  build:
    - python>={{ python_min }}
    - setuptools>=64
    - setuptools_scm>=8
  run:
    - python>={{ python_min }}
    - mdanalysis=2.7
    - paramiko=3.5
    - fabric=3.2
    - invoke=2.2
    - pyyaml=6.0
    - hole2=2.3  # [not arm64]
    - freesasa=2.2  # [not arm64]
    - dssp  # [not arm64]
{% if suffix != 'client' %}
    - fastapi=0.115
    - uvicorn=0.32
    - jinja2=3.1
    - sqlmodel>=0.0.22
    - email-validator=2.2
    - python-multipart>=0.0.17
{% endif %}
{% if suffix == 'dev' %}
    - pylsp-mypy=0.6
    - sphinx=8.1
    - sphinx-js=3.2
{% endif %}
